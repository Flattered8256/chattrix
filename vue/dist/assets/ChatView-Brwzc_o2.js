import{d as V,a as f,n as q,p as K,q as j,s as x,x as I,y as W,c as n,F as O,f as b,b as l,e as Y,z as se,o,A as H,B,i as T,t as L,_ as E,u as le,C as F,g as re,v as ce,w as ue}from"./index-VbH6-5Ed.js";import{A as Z}from"./Avatar_look-56GrP5B0.js";import{T as te}from"./toast-DP4XDF7b.js";const de={key:0,class:"empty-state-mobile"},me={class:"chat-list-container"},ve={class:"chat-list"},ge=["onClick"],he={class:"chat-info"},pe={class:"chat-header"},fe={class:"chat-username"},we={key:0,class:"unread-badge"},_e={class:"last-message"},ye={class:"message-content"},Ce=V({__name:"chat_list",emits:["select-chat"],setup(S,{emit:C}){const m=f(!1),a=()=>{m.value=window.innerWidth<768};q(()=>{a(),window.addEventListener("resize",a)}),K(()=>{window.removeEventListener("resize",a)});const i=C,t=j(),e=x(),s=f(!1),r=f(""),h=f("error"),g=y=>e.unreadMessagesCount.get(y)||0,_=y=>{const M=e.messages[y];if(!M||M.length===0)return"";const u=M[M.length-1];if(!u)return"未知消息";let k="";return u.messages_type==="image"?k="[图片消息]":u.messages_type==="video"?k="[视频消息]":u.messages_type==="file"?k="[文件消息]":u.content?k=u.content.length>30?u.content.substring(0,30)+"...":u.content:k="未知消息",u.room_type==="group"?`${u.sender?.username||"未知用户"}: ${k}`:k},c=I(()=>[...t.privateChatRooms,...t.groupChatRooms].sort((M,u)=>{const k=e.messages[M.id]||[],$=e.messages[u.id]||[];if(k.length===0&&$.length===0)return new Date(u.updated_at).getTime()-new Date(M.updated_at).getTime();if(k.length===0)return 1;if($.length===0)return-1;{const A=k[k.length-1],z=$[$.length-1];return new Date(z.timestamp).getTime()-new Date(A.timestamp).getTime()}})),R=y=>{e.setCurrentChatRoom(y),i("select-chat")},D=y=>{r.value=y,h.value="error",s.value=!0},P=()=>{s.value=!1};return W(()=>t.error,y=>{y&&D(y)}),(y,M)=>(o(),n(O,null,[m.value&&c.value.length===0?(o(),n("div",de,M[0]||(M[0]=[l("div",{class:"empty-state-icon"},[l("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[l("path",{d:"M20 2H4C2.9 2 2.01 2.9 2.01 4L2 22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z",fill:"#ccc"})])],-1),l("h3",null,"暂无聊天记录",-1),l("p",null,"您还没有任何聊天消息，开始和好友聊天吧！",-1)]))):b("",!0),l("div",me,[l("div",ve,[(o(!0),n(O,null,se(c.value,u=>(o(),n("div",{key:u.id,class:H(["chat-item",{active:u.id===B(t).currentChatRoomId}]),onClick:k=>R(u.id)},[T(Z,{user:{id:B(t).getChatRoomDisplayInfo(u).id,username:B(t).getChatRoomDisplayInfo(u).name,user_avatar:B(t).getChatRoomDisplayInfo(u).avatar},size:"medium"},null,8,["user"]),l("div",he,[l("div",pe,[l("span",fe,L(B(t).getChatRoomDisplayInfo(u).name),1),g(u.id)>0?(o(),n("span",we,L(g(u.id)),1)):b("",!0)]),l("div",_e,[l("span",ye,L(_(u.id)),1)])])],10,ge))),128))]),s.value?(o(),Y(te,{key:0,message:r.value,type:h.value,onClose:P},null,8,["message","type"])):b("",!0)])],64))}}),Q=E(Ce,[["__scopeId","data-v-4d8281e6"]]),ke="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760855580909'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='2923'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M645.12%200H194.56C112.64%200%2051.2%2066.56%2051.2%20143.36v737.28C51.2%20957.44%20112.64%201024%20194.56%201024h634.88c76.8%200%20143.36-66.56%20143.36-143.36V332.8L645.12%200z%20m20.48%20168.96L803.84%20307.2H665.6V168.96z%20m204.8%20711.68c0%2020.48-15.36%2040.96-40.96%2040.96H194.56c-25.6%200-40.96-20.48-40.96-40.96V143.36c0-20.48%2015.36-40.96%2040.96-40.96H563.2v215.04c0%2051.2%2040.96%2092.16%2092.16%2092.16H870.4v471.04z'%20fill='%2300D6D6'%20p-id='2924'%3e%3c/path%3e%3c/svg%3e",Me={class:"message-content-wrapper"},be={key:1,class:"media-container"},Re=["src","alt"],$e={key:2,class:"media-container"},Te=["src"],Se=["href","download"],Ie=V({__name:"MessageContent",props:{message:{},isSent:{type:Boolean}},emits:["previewMedia"],setup(S,{emit:C}){const m=C,a=e=>{if(!e)return"";const s=new Date(e),r=new Date;return s.toDateString()===r.toDateString()?s.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},i=(e,s=20)=>{if(e.length<=s)return e;const r=e.lastIndexOf(".");if(r===-1)return e.substring(0,s)+"...";const h=e.substring(0,r),g=e.substring(r),_=s-g.length-3;return _<=0?"..."+g.substring(0,s-3):h.substring(0,_)+"..."+g},t=(e,s)=>{m("previewMedia",e,s)};return(e,s)=>(o(),n("div",Me,[e.message.messages_type==="text"?(o(),n("div",{key:0,class:H(["message-bubble",e.isSent?"sent-bubble":"received-bubble"])},L(e.message.content),3)):e.message.messages_type==="image"?(o(),n("div",be,[l("img",{src:e.message.file,alt:e.message.filename||e.message.content||"",class:"message-image",onClick:s[0]||(s[0]=r=>t(e.message.file,"image"))},null,8,Re)])):e.message.messages_type==="video"?(o(),n("div",$e,[l("video",{src:e.message.file,controls:"",class:"message-video"},null,8,Te)])):e.message.messages_type==="file"?(o(),n("div",{key:3,class:H(["media-container",{"media-container-sent":e.isSent}])},[l("a",{href:e.message.file,download:e.message.filename||"",class:H(["file-download",{"file-download-sent":e.isSent}])},s[1]||(s[1]=[l("img",{src:ke,alt:"文件",class:"file-icon-svg"},null,-1)]),10,Se),e.message.filename?(o(),n("span",{key:0,class:H(["media-filename",{"media-filename-sent":e.isSent}])},L(i(e.message.filename)),3)):b("",!0)],2)):b("",!0),l("div",{class:H(["message-time",{"time-right":e.isSent}])},L(a(e.message.timestamp)),3)]))}}),X=E(Ie,[["__scopeId","data-v-77dc93f3"]]),De=["id"],Be={class:"message-avatar"},Le={key:0,class:"message-username"},Ve={class:"message-content"},Ee={class:"message-content"},Ue={class:"message-avatar"},ze=V({__name:"MessageItem",props:{message:{},currentUserId:{},currentUser:{}},emits:["previewMedia"],setup(S,{emit:C}){const m=S,a=C,i=I(()=>m.message.sender?.id===m.currentUserId),t=I(()=>m.message.room_type==="group");return(e,s)=>(o(),n("div",{id:`message-${e.message.id}`,class:H(["message-item",i.value?"sent":"received"])},[i.value?(o(),n(O,{key:1},[l("div",Ee,[T(X,{message:e.message,"is-sent":i.value,onPreviewMedia:s[1]||(s[1]=(r,h)=>a("previewMedia",r,h))},null,8,["message","is-sent"])]),l("div",Ue,[T(Z,{user:e.currentUser,size:"small"},null,8,["user"])])],64)):(o(),n(O,{key:0},[l("div",Be,[T(Z,{user:e.message.sender,size:"small"},null,8,["user"]),t.value?(o(),n("div",Le,L(e.message.sender?.username||"未知用户"),1)):b("",!0)]),l("div",Ve,[T(X,{message:e.message,"is-sent":i.value,onPreviewMedia:s[0]||(s[0]=(r,h)=>a("previewMedia",r,h))},null,8,["message","is-sent"])])],64))],10,De))}}),He=E(ze,[["__scopeId","data-v-1324a99d"]]),Pe={key:0,class:"loading-messages"},Ae={key:1,class:"empty-messages"},Ne={key:2,class:"no-chat-selected-content"},Fe={key:3,class:"messages-list"},Ge={key:0,class:"loading-more"},We={key:1,class:"no-more-messages"},Oe=V({__name:"MessageList",props:{currentChatRoom:{}},emits:["preview-media"],setup(S,{expose:C,emit:m}){const a=S,i=m,t=x(),e=le(),s=f(null),r=f(!1),h=f(null),g=I(()=>e.user?.id||0),_=I(()=>e.user),c=I(()=>a.currentChatRoom?t.messages[a.currentChatRoom.id]||[]:[]),R=I(()=>a.currentChatRoom&&t.isMessagesLoading.get(a.currentChatRoom.id)||!1),D=I(()=>a.currentChatRoom?t.paginationState[a.currentChatRoom.id]:null),P=I(()=>a.currentChatRoom&&D.value&&!D.value.hasMore&&c.value.length>0),y=async v=>{if(v)try{(!t.messages[v]||t.messages[v].length===0)&&await t.getRoomMessages(v),F(()=>{$()})}catch(p){console.error("加载消息失败:",p)}},M=async()=>{if(!a.currentChatRoom||r.value)return;const v=a.currentChatRoom.id,p=D.value;if(!(!p||!p.hasMore||p.isLoadingMore)){h.value=G(),console.log("加载前锚点消息ID:",h.value),r.value=!0;try{const d=await t.getRoomMessages(v,!0);!d.success&&d.error?console.error("加载更多消息失败:",d.error):(await new Promise(w=>setTimeout(w,100)),await F(),await new Promise(w=>setTimeout(w,50)),h.value?await A(h.value):z())}catch(d){console.error("加载更多消息失败:",d)}finally{r.value=!1,h.value=null}}},u=()=>{if(!s.value||!a.currentChatRoom||r.value)return;const{scrollTop:v}=s.value;v<200&&M()},k=(v,p)=>{i("preview-media",v,p)},$=()=>{s.value&&requestAnimationFrame(()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)})},A=async v=>{if(!s.value)return;await F();const p=document.getElementById(`message-${v}`);if(!p){console.warn("锚点元素未找到，使用备用方案"),z();return}const d=s.value,w=p.getBoundingClientRect(),U=d.getBoundingClientRect(),N=w.top-U.top,ae=p.offsetTop-N;d.scrollTop=ae,setTimeout(()=>{if(s.value){const J=document.getElementById(`message-${v}`);if(J){const oe=J.getBoundingClientRect(),ne=s.value.getBoundingClientRect(),ie=oe.top-ne.top;Math.abs(ie-N)>10&&(s.value.scrollTop=J.offsetTop-N)}}},150)},z=()=>{if(!s.value)return;const v=s.value,p=v.querySelectorAll(".message-item");if(p.length>10){const d=p[10];d&&(v.scrollTop=d.offsetTop-50)}},G=()=>{if(!s.value||!c.value.length)return null;const v=s.value,d=v.getBoundingClientRect().top;for(const w of c.value){const U=document.getElementById(`message-${w.id}`);if(U){const N=U.getBoundingClientRect();if(N.top>=d&&N.top<d+v.clientHeight*.3)return w.id}}return c.value[0]?.id||null};return W(()=>c.value.length,(v,p)=>{a.currentChatRoom&&!r.value&&v>p&&F(()=>{$()})}),W(c,(v,p)=>{a.currentChatRoom&&!r.value&&p&&v&&v.length>p.length&&F(()=>{$()})},{deep:!0}),q(()=>{s.value&&s.value.addEventListener("scroll",u),a.currentChatRoom&&y(a.currentChatRoom.id)}),K(()=>{s.value&&s.value.removeEventListener("scroll",u)}),C({scrollToBottom:$,restoreScrollPosition:A,getAnchorMessageId:G,fallbackScrollRestore:z}),(v,p)=>(o(),n("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s,onScroll:u},[R.value?(o(),n("div",Pe," 加载消息中... ")):v.currentChatRoom&&c.value.length===0?(o(),n("div",Ae," 暂无消息，开始聊天吧！ ")):v.currentChatRoom?(o(),n("div",Fe,[r.value?(o(),n("div",Ge," 加载更多消息中... ")):b("",!0),P.value?(o(),n("div",We," 没有更多消息了 ")):b("",!0),(o(!0),n(O,null,se(c.value,d=>(o(),Y(He,{key:d.id,message:d,"current-user-id":g.value,"current-user":_.value,onPreviewMedia:k},null,8,["message","current-user-id","current-user"]))),128))])):(o(),n("div",Ne,p[0]||(p[0]=[l("p",null,"从左侧列表选择一个聊天开始对话",-1)])))],544))}}),Ye=E(Oe,[["__scopeId","data-v-c6b2b491"]]),Ze={class:"chat-header"},qe={key:1,class:"chat-partner-info"},Ke={class:"partner-details"},je={class:"partner-name"},xe={key:2,class:"no-chat-selected"},Je=V({__name:"ChatHeader",props:{chatRoom:{},isMobile:{type:Boolean}},emits:["back"],setup(S,{emit:C}){const m=j(),a=C,i=()=>{a("back")};return(t,e)=>(o(),n("div",Ze,[t.isMobile&&t.chatRoom?(o(),n("button",{key:0,class:"back-button",onClick:i}," ← ")):b("",!0),t.chatRoom?(o(),n("div",qe,[T(Z,{user:{id:B(m).getChatRoomDisplayInfo(t.chatRoom).id,username:B(m).getChatRoomDisplayInfo(t.chatRoom).name,user_avatar:B(m).getChatRoomDisplayInfo(t.chatRoom).avatar},size:"medium"},null,8,["user"]),l("div",Ke,[l("span",je,L(B(m).getChatRoomDisplayInfo(t.chatRoom).name),1)])])):(o(),n("div",xe," 请选择一个聊天 "))]))}}),Qe=E(Je,[["__scopeId","data-v-d00b59d3"]]),Xe="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760852078773'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='980'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M539.7%20357.6h-55.4v126.7H357.6v55.4h126.7v126.7h55.4V539.7h126.7v-55.4H539.7z'%20p-id='981'%3e%3c/path%3e%3cpath%20d='M512%20142.9c-203.5%200-369.1%20165.6-369.1%20369.1S308.5%20881.1%20512%20881.1%20881.1%20715.5%20881.1%20512%20715.5%20142.9%20512%20142.9z%20m0%20682.7c-172.9%200-313.6-140.7-313.6-313.6S339.1%20198.4%20512%20198.4%20825.6%20339.1%20825.6%20512%20684.9%20825.6%20512%20825.6z'%20p-id='982'%3e%3c/path%3e%3c/svg%3e",es={class:"message-sender"},ss=["disabled"],ts=["disabled"],as=["disabled"],os=V({__name:"MessageSend",props:{disabled:{type:Boolean}},emits:["send-text","send-file"],setup(S,{emit:C}){const m=C,a=f(""),i=f(),t=I(()=>a.value.trim().length>0);function e(){t.value&&(m("send-text",a.value.trim()),a.value="")}function s(g){g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),e())}function r(){i.value?.click()}function h(g){const _=g.target,c=_.files?.[0];if(!c)return;let R="file";c.type.startsWith("image/")?R="image":c.type.startsWith("video/")&&(R="video"),m("send-file",c,R),_.value=""}return(g,_)=>(o(),n("div",es,[l("button",{class:"upload-button",disabled:g.disabled,onClick:r},_[1]||(_[1]=[l("img",{src:Xe,class:"upload-icon"},null,-1)]),8,ss),l("input",{ref_key:"fileInput",ref:i,type:"file",class:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar",onChange:h},null,544),re(l("textarea",{"onUpdate:modelValue":_[0]||(_[0]=c=>a.value=c),class:"message-input",disabled:g.disabled,placeholder:"输入消息…",onKeydown:s,rows:"1"},null,40,ts),[[ce,a.value]]),l("button",{class:"send-button",disabled:g.disabled||!t.value,onClick:e},L(g.disabled?"发送中…":"发送"),9,as)]))}}),ns=E(os,[["__scopeId","data-v-559ffe38"]]),is=["src","alt"],ls=["src"],rs={key:2,class:"loading-indicator"},cs={key:3,class:"error-message"},us=V({__name:"MediaPreview",props:{show:{type:Boolean,default:!1},previewUrl:{},previewType:{},altText:{default:"媒体预览"}},emits:["close","update:show"],setup(S,{emit:C}){const m=C,a=S,i=f(!0),t=f(!1),e=()=>{m("close"),m("update:show",!1)},s=()=>{e()},r=()=>{i.value=!1,t.value=!1},h=()=>{i.value=!1,t.value=!0},g=()=>{i.value=!1,t.value=!1},_=()=>{i.value=!1,t.value=!0};return W(()=>a.show,c=>{c&&(i.value=!0,t.value=!1)}),W(()=>a.previewUrl,()=>{a.show&&(i.value=!0,t.value=!1)}),(c,R)=>c.show?(o(),n("div",{key:0,class:"media-preview-overlay",onClick:s},[l("div",{class:"media-preview-container",onClick:R[0]||(R[0]=ue(()=>{},["stop"]))},[l("button",{class:"close-preview",onClick:e,"aria-label":"关闭预览"},"×"),c.previewType==="image"?(o(),n("img",{key:0,src:c.previewUrl,class:"preview-image",alt:c.altText,onLoad:r,onError:h},null,40,is)):c.previewType==="video"?(o(),n("video",{key:1,src:c.previewUrl,class:"preview-video",controls:"",onLoadeddata:g,onError:_}," 您的浏览器不支持视频播放 ",40,ls)):b("",!0),i.value?(o(),n("div",rs," 加载中... ")):b("",!0),t.value?(o(),n("div",cs," 加载失败，请重试 ")):b("",!0)])])):b("",!0)}}),ds=E(us,[["__scopeId","data-v-d2385574"]]),ms={class:"chat-container"},vs=V({__name:"chat",emits:["back"],setup(S,{emit:C}){const m=C,a=j(),i=x(),t=f(!1),e=f(!1),s=f(""),r=f("error"),h=f(!1),g=f(!1),_=f(""),c=f("image"),R=f(),D=()=>{const d=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${d}px`)},P=()=>{h.value=window.innerWidth<=767,h.value&&D()};D(),P(),window.addEventListener("resize",()=>{P(),D()}),window.addEventListener("orientationchange",D);const y=I(()=>a.currentChatRoom),M=()=>{m("back")};q(()=>{i.isUserViewingChat=!0}),K(()=>{i.isUserViewingChat=!1});async function u(d){await $({content:d,messages_type:"text",room_type:"private"})}async function k(d,w){await $({file:d,messages_type:w,room_type:"private"})}async function $(d){if(y.value){t.value=!0;try{const{success:w,error:U}=await i.sendMessage(y.value.id,d);if(!w)throw new Error(U||"未知错误");F(()=>A())}catch(w){z("发送失败: "+w.message)}finally{t.value=!1}}}const A=()=>{R.value?.scrollToBottom()},z=(d,w="error")=>{s.value=d,r.value=w,e.value=!0,setTimeout(()=>{G()},3e3)},G=()=>{e.value=!1},v=(d,w)=>{_.value=d,c.value=w,g.value=!0},p=()=>{g.value=!1};return(d,w)=>(o(),n("div",ms,[T(Qe,{"chat-room":y.value,"is-mobile":h.value,onBack:M},null,8,["chat-room","is-mobile"]),T(Ye,{ref_key:"messageListRef",ref:R,"current-chat-room":y.value,onPreviewMedia:v},null,8,["current-chat-room"]),T(ns,{disabled:t.value,onSendText:u,onSendFile:k},null,8,["disabled"]),T(ds,{show:g.value,"onUpdate:show":w[0]||(w[0]=U=>g.value=U),"preview-url":_.value,"preview-type":c.value,"alt-text":"聊天图片预览",onClose:p},null,8,["show","preview-url","preview-type"]),e.value?(o(),Y(te,{key:0,message:s.value,type:r.value,onClose:G},null,8,["message","type"])):b("",!0)]))}}),ee=E(vs,[["__scopeId","data-v-3eb671b8"]]),gs={class:"chat-view"},hs={key:0,class:"mobile-layout"},ps={key:1,class:"desktop-layout"},fs={class:"chat-list-panel"},ws={class:"chat-panel"},_s=V({__name:"ChatView",setup(S){const C=j(),m=x(),a=f(!1),i=f(!1);let t=0;const e=()=>{i.value=window.innerWidth<768,i.value||(a.value=!0)},s=()=>{t=window.scrollY,a.value=!0,m.isUserViewingChat=!0,i.value&&document.body.classList.add("mobile-chat-open")},r=()=>{a.value=!1,m.isUserViewingChat=!1,C.currentChatRoomId=null,i.value&&(document.body.classList.remove("mobile-chat-open"),window.scrollTo(0,t))},h=()=>{e()};return q(()=>{e(),window.addEventListener("resize",h),i.value&&C.currentChatRoom?(a.value=!0,m.isUserViewingChat=!0):!i.value&&a.value&&(m.isUserViewingChat=!0)}),K(()=>{window.removeEventListener("resize",h),m.isUserViewingChat=!1}),(g,_)=>(o(),n("div",gs,[i.value?(o(),n("div",hs,[a.value?(o(),Y(ee,{key:1,onBack:r})):(o(),Y(Q,{key:0,onSelectChat:s}))])):(o(),n("div",ps,[l("div",fs,[T(Q,{onSelectChat:s})]),l("div",ws,[T(ee)])]))]))}}),Ms=E(_s,[["__scopeId","data-v-37829c5c"]]);export{Ms as default};
