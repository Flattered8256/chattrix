import{d as H,a as f,n as x,p as j,q as J,s as Q,x as D,y as W,c as l,F as q,f as b,b as u,e as Z,z as te,o,A as z,B as I,i as $,t as L,_ as V,u as ne,C as A,g as ie,v as le,w as re}from"./index-BXyf1cX8.js";import{A as K}from"./Avatar_look-99SN0T24.js";import{T as ae}from"./toast-ButgNYK3.js";const ce={key:0,class:"empty-state-mobile"},ue={class:"chat-list-container"},de={class:"chat-list"},me=["onClick"],ve={class:"chat-info"},he={class:"chat-header"},ge={class:"chat-username"},pe={key:0,class:"unread-badge"},fe={class:"last-message"},we={class:"message-content"},_e=H({__name:"chat_list",emits:["select-chat"],setup(R,{emit:y}){const m=f(!1),a=()=>{m.value=window.innerWidth<768};x(()=>{a(),window.addEventListener("resize",a)}),j(()=>{window.removeEventListener("resize",a)});const r=y,t=J(),e=Q(),s=f(!1),d=f(""),g=f("error"),v=_=>e.unreadMessagesCount.get(_)||0,p=_=>{const M=e.messages[_];if(!M||M.length===0)return"";const h=M[M.length-1];if(!h)return"未知消息";let C="";return h.messages_type==="image"?C="[图片消息]":h.messages_type==="video"?C="[视频消息]":h.messages_type==="file"?C="[文件消息]":h.content?C=h.content.length>30?h.content.substring(0,30)+"...":h.content:C="未知消息",h.room_type==="group"?`${h.sender?.username||"未知用户"}: ${C}`:C},w=D(()=>[...t.privateChatRooms,...t.groupChatRooms].sort((M,h)=>{const C=e.messages[M.id]||[],S=e.messages[h.id]||[];if(C.length===0&&S.length===0)return new Date(h.updated_at).getTime()-new Date(M.updated_at).getTime();if(C.length===0)return 1;if(S.length===0)return-1;{const N=C[C.length-1],E=S[S.length-1];return new Date(E.timestamp).getTime()-new Date(N.timestamp).getTime()}})),T=_=>{e.setCurrentChatRoom(_),r("select-chat")},k=_=>{d.value=_,g.value="error",s.value=!0},P=()=>{s.value=!1};return W(()=>t.error,_=>{_&&k(_)}),(_,M)=>(o(),l(q,null,[m.value&&w.value.length===0?(o(),l("div",ce,M[0]||(M[0]=[u("div",{class:"empty-state-icon"},[u("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[u("path",{d:"M20 2H4C2.9 2 2.01 2.9 2.01 4L2 22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z",fill:"#ccc"})])],-1),u("h3",null,"暂无聊天记录",-1),u("p",null,"您还没有任何聊天消息，开始和好友聊天吧！",-1)]))):b("",!0),u("div",ue,[u("div",de,[(o(!0),l(q,null,te(w.value,h=>(o(),l("div",{key:h.id,class:z(["chat-item",{active:h.id===I(t).currentChatRoomId}]),onClick:C=>T(h.id)},[$(K,{user:{id:I(t).getChatRoomDisplayInfo(h).id,username:I(t).getChatRoomDisplayInfo(h).name,user_avatar:I(t).getChatRoomDisplayInfo(h).avatar},size:"medium"},null,8,["user"]),u("div",ve,[u("div",he,[u("span",ge,L(I(t).getChatRoomDisplayInfo(h).name),1),v(h.id)>0?(o(),l("span",pe,L(v(h.id)),1)):b("",!0)]),u("div",fe,[u("span",we,L(p(h.id)),1)])])],10,me))),128))]),s.value?(o(),Z(ae,{key:0,message:d.value,type:g.value,onClose:P},null,8,["message","type"])):b("",!0)])],64))}}),X=V(_e,[["__scopeId","data-v-4d8281e6"]]),ye="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760855580909'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='2923'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M645.12%200H194.56C112.64%200%2051.2%2066.56%2051.2%20143.36v737.28C51.2%20957.44%20112.64%201024%20194.56%201024h634.88c76.8%200%20143.36-66.56%20143.36-143.36V332.8L645.12%200z%20m20.48%20168.96L803.84%20307.2H665.6V168.96z%20m204.8%20711.68c0%2020.48-15.36%2040.96-40.96%2040.96H194.56c-25.6%200-40.96-20.48-40.96-40.96V143.36c0-20.48%2015.36-40.96%2040.96-40.96H563.2v215.04c0%2051.2%2040.96%2092.16%2092.16%2092.16H870.4v471.04z'%20fill='%2300D6D6'%20p-id='2924'%3e%3c/path%3e%3c/svg%3e",Ce={class:"message-content-wrapper"},ke={key:1,class:"media-container"},Me=["src","alt"],be={key:2,class:"media-container"},Te=["src"],Se=["href","download"],$e=H({__name:"MessageContent",props:{message:{},isSent:{type:Boolean}},emits:["previewMedia"],setup(R,{emit:y}){const m=y,a=e=>{if(!e)return"";const s=new Date(e),d=new Date;return s.toDateString()===d.toDateString()?s.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},r=(e,s=20)=>{if(e.length<=s)return e;const d=e.lastIndexOf(".");if(d===-1)return e.substring(0,s)+"...";const g=e.substring(0,d),v=e.substring(d),p=s-v.length-3;return p<=0?"..."+v.substring(0,s-3):g.substring(0,p)+"..."+v},t=(e,s)=>{m("previewMedia",e,s)};return(e,s)=>(o(),l("div",Ce,[e.message.messages_type==="text"?(o(),l("div",{key:0,class:z(["message-bubble",e.isSent?"sent-bubble":"received-bubble"])},L(e.message.content),3)):e.message.messages_type==="image"?(o(),l("div",ke,[u("img",{src:e.message.file,alt:e.message.filename||e.message.content||"",class:"message-image",onClick:s[0]||(s[0]=d=>t(e.message.file,"image"))},null,8,Me)])):e.message.messages_type==="video"?(o(),l("div",be,[u("video",{src:e.message.file,controls:"",class:"message-video"},null,8,Te)])):e.message.messages_type==="file"?(o(),l("div",{key:3,class:z(["media-container",{"media-container-sent":e.isSent}])},[u("a",{href:e.message.file,download:e.message.filename||"",class:z(["file-download",{"file-download-sent":e.isSent}])},s[1]||(s[1]=[u("img",{src:ye,alt:"文件",class:"file-icon-svg"},null,-1)]),10,Se),e.message.filename?(o(),l("span",{key:0,class:z(["media-filename",{"media-filename-sent":e.isSent}])},L(r(e.message.filename)),3)):b("",!0)],2)):b("",!0),u("div",{class:z(["message-time",{"time-right":e.isSent}])},L(a(e.message.timestamp)),3)]))}}),ee=V($e,[["__scopeId","data-v-77dc93f3"]]),Re=["id"],De={class:"message-avatar"},Ie={key:0,class:"message-username"},Le={class:"message-content"},He={class:"message-content"},Ve={class:"message-avatar"},Ee=H({__name:"MessageItem",props:{message:{},currentUserId:{},currentUser:{}},emits:["previewMedia"],setup(R,{emit:y}){const m=R,a=y,r=D(()=>m.message.sender?.id===m.currentUserId),t=D(()=>m.message.room_type==="group");return(e,s)=>(o(),l("div",{id:`message-${e.message.id}`,class:z(["message-item",r.value?"sent":"received"])},[r.value?(o(),l(q,{key:1},[u("div",He,[$(ee,{message:e.message,"is-sent":r.value,onPreviewMedia:s[1]||(s[1]=(d,g)=>a("previewMedia",d,g))},null,8,["message","is-sent"])]),u("div",Ve,[$(K,{user:e.currentUser,size:"small"},null,8,["user"])])],64)):(o(),l(q,{key:0},[u("div",De,[$(K,{user:e.message.sender,size:"small"},null,8,["user"]),t.value?(o(),l("div",Ie,L(e.message.sender?.username||"未知用户"),1)):b("",!0)]),u("div",Le,[$(ee,{message:e.message,"is-sent":r.value,onPreviewMedia:s[0]||(s[0]=(d,g)=>a("previewMedia",d,g))},null,8,["message","is-sent"])])],64))],10,Re))}}),Be=V(Ee,[["__scopeId","data-v-1324a99d"]]),Ue={key:0,class:"loading-messages"},ze={key:1,class:"empty-messages"},Pe={key:2,class:"no-chat-selected-content"},Ae={key:3,class:"messages-list"},Ne={key:0,class:"no-more-messages"},Fe={key:1,class:"loading-more"},Ge=H({__name:"MessageList",props:{currentChatRoom:{}},emits:["preview-media"],setup(R,{expose:y,emit:m}){const a=R,r=m,t=Q(),e=ne(),s=f(null),d=f(!1),g=f(null),v=f(null),p=f(null),w=D(()=>e.user?.id||0),T=D(()=>e.user),k=D(()=>a.currentChatRoom?t.messages[a.currentChatRoom.id]||[]:[]),P=D(()=>a.currentChatRoom&&t.isMessagesLoading.get(a.currentChatRoom.id)||!1),_=D(()=>a.currentChatRoom?t.paginationState[a.currentChatRoom.id]:null),M=D(()=>a.currentChatRoom&&_.value&&!_.value.hasMore&&k.value.length>0),h=async i=>{if(i)try{(!t.messages[i]||t.messages[i].length===0)&&await t.getRoomMessages(i),A(()=>{E()})}catch(n){console.error("加载消息失败:",n)}},C=async()=>{if(!a.currentChatRoom||d.value)return;const i=a.currentChatRoom.id,n=_.value;if(!n||!n.hasMore||n.isLoadingMore)return;g.value=Y();const c=s.value;if(!c)return;const B=c.scrollTop,U=c.scrollHeight;c.style.minHeight=`${c.offsetHeight}px`,d.value=!0,v.value=Date.now();try{c.style.willChange="scroll-position",c.style.pointerEvents="none";const G=await t.getRoomMessages(i,!0);if(!G.success&&G.error)console.error("加载更多消息失败:",G.error);else{await A();const oe=c.scrollHeight-U;c.style.transform="translateZ(0)",requestAnimationFrame(()=>{c.scrollTop=B+oe,g.value&&F(g.value),c.style.pointerEvents="",c.style.willChange="",c.style.transform="",c.style.minHeight=""})}}catch(G){console.error("加载更多消息失败:",G),c.style.pointerEvents="",c.style.willChange="",c.style.transform="",c.style.minHeight=""}finally{d.value=!1,g.value=null}},S=()=>{if(!s.value||!a.currentChatRoom||d.value)return;const{scrollTop:i}=s.value;i<200&&(p.value&&clearTimeout(p.value),p.value=window.setTimeout(()=>{const n=Date.now();(!v.value||n-v.value>500)&&C()},300))},N=(i,n)=>{r("preview-media",i,n)},E=()=>{s.value&&requestAnimationFrame(()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)})},F=async i=>{if(!s.value)return;await A();const n=s.value,c=document.getElementById(`message-${i}`);if(!c){console.warn("锚点元素未找到，使用备用方案"),O();return}const B=c.offsetTop;n.scrollTop=B,n.style.transform="translateZ(0)",requestAnimationFrame(()=>{const U=c.offsetTop;Math.abs(n.scrollTop-U)>3&&(n.scrollTop=U)})},O=()=>{if(!s.value)return;const i=s.value,n=i.querySelectorAll(".message-item");if(n.length>10){const c=n[10];if(c){const B=i.clientHeight;i.scrollTop=c.offsetTop-B*.3}}},Y=()=>{if(!s.value||!k.value.length)return null;const i=s.value,n=document.querySelectorAll(".message-item");if(n.length===0)return k.value[0].id;for(const c of n){const B=c.getBoundingClientRect();if(B.top>=0&&B.top<=i.clientHeight){const U=c.id.match(/^message-(\d+)$/);if(U)return Number(U[1]);break}}return k.value[0].id};return W(()=>k.value.length,(i,n)=>{a.currentChatRoom&&!d.value&&i>n&&A(()=>{E()})}),W(k,(i,n)=>{a.currentChatRoom&&!d.value&&n&&i&&i.length>n.length&&A(()=>{E()})},{deep:!0}),x(()=>{s.value&&s.value.addEventListener("scroll",S),a.currentChatRoom&&h(a.currentChatRoom.id)}),j(()=>{s.value&&s.value.removeEventListener("scroll",S),p.value&&clearTimeout(p.value)}),y({scrollToBottom:E,restoreScrollPosition:F,getAnchorMessageId:Y,fallbackScrollRestore:O}),(i,n)=>(o(),l("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s,onScroll:S},[P.value?(o(),l("div",Ue," 加载消息中... ")):i.currentChatRoom&&k.value.length===0?(o(),l("div",ze," 暂无消息，开始聊天吧！ ")):i.currentChatRoom?(o(),l("div",Ae,[M.value?(o(),l("div",Ne," 没有更多消息了 ")):b("",!0),d.value?(o(),l("div",Fe," 加载消息中... ")):b("",!0),(o(!0),l(q,null,te(k.value,c=>(o(),Z(Be,{key:c.id,message:c,"current-user-id":w.value,"current-user":T.value,onPreviewMedia:N},null,8,["message","current-user-id","current-user"]))),128))])):(o(),l("div",Pe,n[0]||(n[0]=[u("p",null,"从左侧列表选择一个聊天开始对话",-1)])))],544))}}),We=V(Ge,[["__scopeId","data-v-292b0346"]]),qe={class:"chat-header"},Ze={key:1,class:"chat-partner-info"},Oe={class:"partner-details"},Ye={class:"partner-name"},Ke={key:2,class:"no-chat-selected"},xe=H({__name:"ChatHeader",props:{chatRoom:{},isMobile:{type:Boolean}},emits:["back"],setup(R,{emit:y}){const m=J(),a=y,r=()=>{a("back")};return(t,e)=>(o(),l("div",qe,[t.isMobile&&t.chatRoom?(o(),l("button",{key:0,class:"back-button",onClick:r}," ← ")):b("",!0),t.chatRoom?(o(),l("div",Ze,[$(K,{user:{id:I(m).getChatRoomDisplayInfo(t.chatRoom).id,username:I(m).getChatRoomDisplayInfo(t.chatRoom).name,user_avatar:I(m).getChatRoomDisplayInfo(t.chatRoom).avatar},size:"medium"},null,8,["user"]),u("div",Oe,[u("span",Ye,L(I(m).getChatRoomDisplayInfo(t.chatRoom).name),1)])])):(o(),l("div",Ke," 请选择一个聊天 "))]))}}),je=V(xe,[["__scopeId","data-v-d00b59d3"]]),Je="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760852078773'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='980'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M539.7%20357.6h-55.4v126.7H357.6v55.4h126.7v126.7h55.4V539.7h126.7v-55.4H539.7z'%20p-id='981'%3e%3c/path%3e%3cpath%20d='M512%20142.9c-203.5%200-369.1%20165.6-369.1%20369.1S308.5%20881.1%20512%20881.1%20881.1%20715.5%20881.1%20512%20715.5%20142.9%20512%20142.9z%20m0%20682.7c-172.9%200-313.6-140.7-313.6-313.6S339.1%20198.4%20512%20198.4%20825.6%20339.1%20825.6%20512%20684.9%20825.6%20512%20825.6z'%20p-id='982'%3e%3c/path%3e%3c/svg%3e",Qe={class:"message-sender"},Xe=["disabled"],es=["disabled"],ss=["disabled"],ts=H({__name:"MessageSend",props:{disabled:{type:Boolean}},emits:["send-text","send-file"],setup(R,{emit:y}){const m=y,a=f(""),r=f(),t=D(()=>a.value.trim().length>0);function e(){t.value&&(m("send-text",a.value.trim()),a.value="")}function s(v){v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),e())}function d(){r.value?.click()}function g(v){const p=v.target,w=p.files?.[0];if(!w)return;let T="file";w.type.startsWith("image/")?T="image":w.type.startsWith("video/")&&(T="video"),m("send-file",w,T),p.value=""}return(v,p)=>(o(),l("div",Qe,[u("button",{class:"upload-button",disabled:v.disabled,onClick:d},p[1]||(p[1]=[u("img",{src:Je,class:"upload-icon"},null,-1)]),8,Xe),u("input",{ref_key:"fileInput",ref:r,type:"file",class:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar",onChange:g},null,544),ie(u("textarea",{"onUpdate:modelValue":p[0]||(p[0]=w=>a.value=w),class:"message-input",disabled:v.disabled,placeholder:"输入消息…",onKeydown:s,rows:"1"},null,40,es),[[le,a.value]]),u("button",{class:"send-button",disabled:v.disabled||!t.value,onClick:e},L(v.disabled?"发送中…":"发送"),9,ss)]))}}),as=V(ts,[["__scopeId","data-v-559ffe38"]]),os=["src","alt"],ns=["src"],is={key:2,class:"loading-indicator"},ls={key:3,class:"error-message"},rs=H({__name:"MediaPreview",props:{show:{type:Boolean,default:!1},previewUrl:{},previewType:{},altText:{default:"媒体预览"}},emits:["close","update:show"],setup(R,{emit:y}){const m=y,a=R,r=f(!0),t=f(!1),e=()=>{m("close"),m("update:show",!1)},s=()=>{e()},d=()=>{r.value=!1,t.value=!1},g=()=>{r.value=!1,t.value=!0},v=()=>{r.value=!1,t.value=!1},p=()=>{r.value=!1,t.value=!0};return W(()=>a.show,w=>{w&&(r.value=!0,t.value=!1)}),W(()=>a.previewUrl,()=>{a.show&&(r.value=!0,t.value=!1)}),(w,T)=>w.show?(o(),l("div",{key:0,class:"media-preview-overlay",onClick:s},[u("div",{class:"media-preview-container",onClick:T[0]||(T[0]=re(()=>{},["stop"]))},[u("button",{class:"close-preview",onClick:e,"aria-label":"关闭预览"},"×"),w.previewType==="image"?(o(),l("img",{key:0,src:w.previewUrl,class:"preview-image",alt:w.altText,onLoad:d,onError:g},null,40,os)):w.previewType==="video"?(o(),l("video",{key:1,src:w.previewUrl,class:"preview-video",controls:"",onLoadeddata:v,onError:p}," 您的浏览器不支持视频播放 ",40,ns)):b("",!0),r.value?(o(),l("div",is," 加载中... ")):b("",!0),t.value?(o(),l("div",ls," 加载失败，请重试 ")):b("",!0)])])):b("",!0)}}),cs=V(rs,[["__scopeId","data-v-d2385574"]]),us={class:"chat-container"},ds=H({__name:"chat",emits:["back"],setup(R,{emit:y}){const m=y,a=J(),r=Q(),t=f(!1),e=f(!1),s=f(""),d=f("error"),g=f(!1),v=f(!1),p=f(""),w=f("image"),T=f(),k=()=>{const i=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${i}px`)},P=()=>{g.value=window.innerWidth<=767,g.value&&k()};k(),P(),window.addEventListener("resize",()=>{P(),k()}),window.addEventListener("orientationchange",k);const _=D(()=>a.currentChatRoom),M=()=>{m("back")};x(()=>{r.isUserViewingChat=!0}),j(()=>{r.isUserViewingChat=!1});async function h(i){await S({content:i,messages_type:"text",room_type:"private"})}async function C(i,n){await S({file:i,messages_type:n,room_type:"private"})}async function S(i){if(_.value){t.value=!0;try{const{success:n,error:c}=await r.sendMessage(_.value.id,i);if(!n)throw new Error(c||"未知错误");A(()=>N())}catch(n){E("发送失败: "+n.message)}finally{t.value=!1}}}const N=()=>{T.value?.scrollToBottom()},E=(i,n="error")=>{s.value=i,d.value=n,e.value=!0,setTimeout(()=>{F()},3e3)},F=()=>{e.value=!1},O=(i,n)=>{p.value=i,w.value=n,v.value=!0},Y=()=>{v.value=!1};return(i,n)=>(o(),l("div",us,[$(je,{"chat-room":_.value,"is-mobile":g.value,onBack:M},null,8,["chat-room","is-mobile"]),$(We,{ref_key:"messageListRef",ref:T,"current-chat-room":_.value,onPreviewMedia:O},null,8,["current-chat-room"]),$(as,{disabled:t.value,onSendText:h,onSendFile:C},null,8,["disabled"]),$(cs,{show:v.value,"onUpdate:show":n[0]||(n[0]=c=>v.value=c),"preview-url":p.value,"preview-type":w.value,"alt-text":"聊天图片预览",onClose:Y},null,8,["show","preview-url","preview-type"]),e.value?(o(),Z(ae,{key:0,message:s.value,type:d.value,onClose:F},null,8,["message","type"])):b("",!0)]))}}),se=V(ds,[["__scopeId","data-v-3eb671b8"]]),ms={class:"chat-view"},vs={key:0,class:"mobile-layout"},hs={key:1,class:"desktop-layout"},gs={class:"chat-list-panel"},ps={class:"chat-panel"},fs=H({__name:"ChatView",setup(R){const y=J(),m=Q(),a=f(!1),r=f(!1);let t=0;const e=()=>{r.value=window.innerWidth<768,r.value||(a.value=!0)},s=()=>{t=window.scrollY,a.value=!0,m.isUserViewingChat=!0,r.value&&document.body.classList.add("mobile-chat-open")},d=()=>{a.value=!1,m.isUserViewingChat=!1,y.currentChatRoomId=null,r.value&&(document.body.classList.remove("mobile-chat-open"),window.scrollTo(0,t))},g=()=>{e()};return x(()=>{e(),window.addEventListener("resize",g),r.value&&y.currentChatRoom?(a.value=!0,m.isUserViewingChat=!0):!r.value&&a.value&&(m.isUserViewingChat=!0)}),j(()=>{window.removeEventListener("resize",g),m.isUserViewingChat=!1}),(v,p)=>(o(),l("div",ms,[r.value?(o(),l("div",vs,[a.value?(o(),Z(se,{key:1,onBack:d})):(o(),Z(X,{key:0,onSelectChat:s}))])):(o(),l("div",hs,[u("div",gs,[$(X,{onSelectChat:s})]),u("div",ps,[$(se)])]))]))}}),ks=V(fs,[["__scopeId","data-v-37829c5c"]]);export{ks as default};
