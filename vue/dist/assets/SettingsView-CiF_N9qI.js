import{d as S,u as E,a as y,x as I,c as d,F as W,b as e,e as M,f as w,A as K,t as b,o as n,_ as V,r as F,p as O,w as z,g as T,v as N,D as q,h as R,C as Z,B as U,l as j,I as G,i as D}from"./index-CzliinOV.js";import{T as L}from"./toast-DvapMaZT.js";const H=["src","alt"],J={key:1,class:"default-avatar"},Q={key:0},X={key:1},Y={key:0,class:"loading-overlay"},ee=S({__name:"Avatar",props:{user:{},size:{default:"medium"}},emits:["avatarUpdated","error"],setup(C,{emit:a}){const u=C,m=a,s=E(),i=y(null),o=y(!1),l=y(""),g=y("success"),p=I(()=>{const v=u.user?.user_avatar||s.user?.user_avatar||"";return v&&!v.startsWith("http")?v.startsWith("/media/")?v:`/media/${v}`:v}),f=I(()=>u.user?.username?u.user.username:s.user?.username||""),k=I(()=>`avatar-${u.size}`),h=()=>{i.value&&i.value.click()},r=async v=>{const t=v.target,c=t.files?.[0];if(c){if(!c.type.startsWith("image/")){x("请选择图片文件","error");return}if(c.size>5*1024*1024){x("图片大小不能超过5MB","error");return}await _(c),t&&(t.value="")}},_=async v=>{o.value=!0;try{if((await s.updateProfile({user_avatar:v})).success&&s.user)x("头像更新成功！","success"),m("avatarUpdated",s.user);else throw new Error("上传失败")}catch(t){const c=t instanceof Error?t.message:"上传失败，请重试";x(c,"error")}finally{o.value=!1}},x=(v,t)=>{l.value=v,g.value=t},B=()=>{l.value=""},A=v=>{const t=v.target;t.style.display="none"};return(v,t)=>(n(),d(W,null,[e("div",{class:"avatar-container",onClick:h},[e("div",{class:K(["avatar-wrapper",k.value])},[p.value?(n(),d("img",{key:0,src:p.value,alt:f.value||"User avatar",class:"avatar-image",onError:A},null,40,H)):(n(),d("div",J,[f.value?(n(),d("span",Q,b(f.value.charAt(0).toUpperCase()),1)):(n(),d("span",X,"U"))])),t[0]||(t[0]=e("div",{class:"upload-overlay"},[e("span",{class:"upload-icon"},"+")],-1))],2),e("input",{ref_key:"fileInput",ref:i,type:"file",accept:"image/*",style:{display:"none"},onChange:r},null,544),o.value?(n(),d("div",Y,t[1]||(t[1]=[e("div",{class:"loading-spinner"},null,-1)]))):w("",!0)]),l.value?(n(),M(L,{key:0,message:l.value,type:g.value,duration:3e3,onClose:B},null,8,["message","type"])):w("",!0)],64))}}),se=V(ee,[["__scopeId","data-v-4071246b"]]),ae={class:"username-container"},te={class:"current-username"},oe={class:"username-info"},re={class:"username-value"},ne={class:"modal-content"},le={class:"modal-body"},ue={class:"form-group"},ie={key:0,class:"error-message"},ce={key:1,class:"username-hint"},de={class:"form-actions"},pe=["disabled"],ve={key:0,class:"loading-spinner-small"},me=S({__name:"username",props:{user:{default:null}},emits:["usernameUpdated","error"],setup(C,{emit:a}){const u=C,m=a,s=E(),i=y(null),o=y(!1),l=y(""),g=y(!1),p=y(""),f=F({message:"",type:"success",duration:3e3}),k=I(()=>u.user?.username?u.user.username:s.user?.username||""),h=I(()=>l.value.trim().length>0&&l.value.trim().length<=20&&l.value.trim()!==k.value),r=()=>{o.value=!0,l.value=k.value,p.value="",Z(()=>{i.value&&(i.value.focus(),i.value.select())})},_=()=>{o.value=!1,l.value="",p.value=""},x=(t,c="success",$=3e3)=>{f.message=t,f.type=c,f.duration=$},B=()=>{f.message=""},A=async()=>{const t=l.value.trim();if(!t){p.value="用户名不能为空";return}if(t.length>20){p.value="用户名不能超过20个字符";return}if(t===k.value){p.value="新用户名与当前用户名相同";return}if(!/^[a-zA-Z0-9_]+$/.test(t)){p.value="用户名只能包含字母、数字和下划线";return}g.value=!0,p.value="";try{if((await s.updateProfile({username:t})).success&&s.user)_(),x("用户名更新成功！"),m("usernameUpdated",s.user);else throw new Error("更新失败")}catch($){const P=$ instanceof Error?$.message:"更新失败，请重试";p.value=P,m("error",P)}finally{g.value=!1}};return O(()=>{}),(t,c)=>(n(),d("div",ae,[e("div",te,[e("div",oe,[c[1]||(c[1]=e("span",{class:"username-label"},"用户名",-1)),e("span",re,b(k.value),1)]),e("button",{class:"edit-button",onClick:r}," 更换用户名 ")]),o.value?(n(),d("div",{key:0,class:"modal-overlay",onClick:z(_,["self"])},[e("div",ne,[e("div",{class:"modal-header"},[c[2]||(c[2]=e("h3",{class:"modal-title"},"更换用户名",-1)),e("button",{class:"modal-close",onClick:_},"×")]),e("div",le,[e("form",{onSubmit:z(A,["prevent"])},[e("div",ue,[c[3]||(c[3]=e("label",{for:"new_username",class:"form-label"},"新用户名",-1)),T(e("input",{id:"new_username",ref_key:"usernameInput",ref:i,"onUpdate:modelValue":c[0]||(c[0]=$=>l.value=$),type:"text",class:"form-input",placeholder:"输入新用户名",onKeydown:[q(A,["enter"]),q(_,["escape"])],maxlength:"20",required:""},null,544),[[N,l.value]])]),p.value?(n(),d("div",ie,b(p.value),1)):w("",!0),!p.value&&l.value?(n(),d("div",ce," 用户名长度 "+b(l.value.length)+"/20 ",1)):w("",!0),e("div",de,[e("button",{type:"submit",class:"save-button",disabled:!h.value||g.value},[g.value?(n(),d("span",ve)):w("",!0),R(" "+b(g.value?"保存中...":"保存"),1)],8,pe),e("button",{type:"button",class:"cancel-button",onClick:_}," 取消 ")])],32)])])])):w("",!0),f.message?(n(),M(L,{key:1,message:f.message,type:f.type,duration:f.duration,onClose:B},null,8,["message","type","duration"])):w("",!0)]))}}),_e=V(me,[["__scopeId","data-v-ffdcff00"]]),fe={class:"password-container"},ge={class:"modal-content"},we={class:"modal-body"},ye={class:"form-group"},he={class:"form-group"},be={class:"form-group"},ke={key:0,class:"error-message"},$e={class:"form-actions"},Ue=["disabled"],Ce={key:0,class:"loading-spinner-small"},xe=S({__name:"password",setup(C){const a=F({old_password:"",new_password:"",confirm_password:""}),u=E(),m=y(!1),s=y(""),i=y(!1),o=F({message:"",type:"success",duration:3e3}),l=()=>{i.value=!0,s.value="",a.old_password="",a.new_password="",a.confirm_password=""},g=()=>{i.value=!1,s.value=""},p=(h,r="success",_=3e3)=>{o.message=h,o.type=r,o.duration=_},f=()=>{o.message=""},k=async()=>{if(s.value="",!a.old_password){s.value="请输入当前密码";return}if(!a.new_password){s.value="请输入新密码";return}if(a.new_password!==a.confirm_password){s.value="两次输入的新密码不一致";return}if(a.new_password.length<6){s.value="新密码长度至少为6位";return}m.value=!0;try{const h=await u.changePassword(a);h.success?(g(),p("密码修改成功")):s.value=h.error||"密码修改失败"}catch(h){s.value="密码修改过程中发生错误",console.error("Change password error:",h)}finally{m.value=!1}};return(h,r)=>(n(),d("div",fe,[e("div",{class:"current-password"},[r[3]||(r[3]=e("div",{class:"password-info"},[e("span",{class:"password-label"},"密码"),e("span",{class:"password-value"},"************")],-1)),e("button",{class:"edit-button",onClick:l}," 修改密码 ")]),i.value?(n(),d("div",{key:0,class:"modal-overlay",onClick:z(g,["self"])},[e("div",ge,[e("div",{class:"modal-header"},[r[4]||(r[4]=e("h3",{class:"modal-title"},"修改密码",-1)),e("button",{class:"modal-close",onClick:g},"×")]),e("div",we,[e("form",{onSubmit:z(k,["prevent"])},[e("div",ye,[r[5]||(r[5]=e("label",{for:"old_password",class:"form-label"},"当前密码",-1)),T(e("input",{id:"old_password","onUpdate:modelValue":r[0]||(r[0]=_=>a.old_password=_),type:"password",class:"form-input",placeholder:"请输入当前密码",required:""},null,512),[[N,a.old_password]])]),e("div",he,[r[6]||(r[6]=e("label",{for:"new_password",class:"form-label"},"新密码",-1)),T(e("input",{id:"new_password","onUpdate:modelValue":r[1]||(r[1]=_=>a.new_password=_),type:"password",class:"form-input",placeholder:"请输入新密码",required:""},null,512),[[N,a.new_password]])]),e("div",be,[r[7]||(r[7]=e("label",{for:"confirm_password",class:"form-label"},"确认新密码",-1)),T(e("input",{id:"confirm_password","onUpdate:modelValue":r[2]||(r[2]=_=>a.confirm_password=_),type:"password",class:"form-input",placeholder:"请再次输入新密码",required:""},null,512),[[N,a.confirm_password]])]),s.value?(n(),d("div",ke,b(s.value),1)):w("",!0),e("div",$e,[e("button",{type:"submit",class:"save-button",disabled:m.value},[m.value?(n(),d("span",Ce)):w("",!0),R(" "+b(m.value?"修改中...":"修改密码"),1)],8,Ue),e("button",{type:"button",class:"cancel-button",onClick:g}," 取消 ")])],32)])])])):w("",!0),o.message?(n(),M(L,{key:1,message:o.message,type:o.type,duration:o.duration,onClose:f},null,8,["message","type","duration"])):w("",!0)]))}}),Ie=V(xe,[["__scopeId","data-v-d42f2151"]]),Me=["disabled"],Se=S({__name:"Logout",setup(C){const a=E(),u=j(),m=a.isLoading,s=async()=>{try{(await a.logout()).success&&u.push({name:"login"})}catch(i){console.error("登出失败:",i),a.clearAuth(),u.push({name:"login"})}};return(i,o)=>(n(),d("button",{class:"logout-button",onClick:s,disabled:U(m)},b(U(m)?"登出中...":"登出"),9,Me))}}),Ee=V(Se,[["__scopeId","data-v-c2585d02"]]),Ve={class:"settings-container"},Ae={class:"user-profile-section"},Te={class:"user-avatar-section"},Ne={class:"user-info-section"},ze={class:"password-section"},Be={class:"logout-section"},Fe=S({__name:"SettingsView",setup(C){const a=E(),{user:u}=G(a),m=o=>{console.error("头像上传错误:",o)},s=o=>{console.log("用户名已更新:",o.username)},i=o=>{console.error("更新用户名时出错:",o)};return(o,l)=>(n(),d("div",Ve,[l[0]||(l[0]=e("h1",null,"设置",-1)),e("div",Ae,[e("div",Te,[D(se,{size:"xlarge",onError:m})]),e("div",Ne,[e("h2",null,b(U(u)?.username||"未登录"),1),e("p",null,"用户ID: "+b(U(u)?.id||"未知"),1)])]),e("div",null,[U(u)?(n(),M(_e,{key:0,user:U(u),onUsernameUpdated:s,onError:i},null,8,["user"])):w("",!0)]),e("div",ze,[U(u)?(n(),M(Ie,{key:0})):w("",!0)]),e("div",Be,[D(Ee)])]))}}),qe=V(Fe,[["__scopeId","data-v-cfdd75e4"]]);export{qe as default};
