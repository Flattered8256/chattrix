import{d as V,a as f,n as q,p as x,q as K,s as j,x as I,y as G,c as n,F as W,f as b,b as r,e as O,z as se,o,A as Y,B,i as T,t as L,_ as E,u as re,C as N,g as le,v as ce,w as ue}from"./index-CrttWU6e.js";import{A as Z}from"./Avatar_look-U-P1R498.js";import{T as te}from"./toast-Bla2j1_g.js";const de={key:0,class:"empty-state-mobile"},me={class:"chat-list-container"},ve={class:"chat-list"},ge=["onClick"],he={class:"chat-info"},pe={class:"chat-header"},fe={class:"chat-username"},we={key:0,class:"unread-badge"},_e={class:"last-message"},ye={class:"message-content"},Ce=V({__name:"chat_list",emits:["select-chat"],setup(S,{emit:C}){const m=f(!1),a=()=>{m.value=window.innerWidth<768};q(()=>{a(),window.addEventListener("resize",a)}),x(()=>{window.removeEventListener("resize",a)});const i=C,t=K(),e=j(),s=f(!1),l=f(""),h=f("error"),g=y=>e.unreadMessagesCount.get(y)||0,_=y=>{const M=e.messages[y];if(!M||M.length===0)return"";const u=M[M.length-1];if(!u)return"未知消息";let k="";return u.messages_type==="image"?k="[图片消息]":u.messages_type==="video"?k="[视频消息]":u.messages_type==="file"?k="[文件消息]":u.content?k=u.content.length>30?u.content.substring(0,30)+"...":u.content:k="未知消息",u.room_type==="group"?`${u.sender?.username||"未知用户"}: ${k}`:k},c=I(()=>[...t.privateChatRooms,...t.groupChatRooms].sort((M,u)=>{const k=e.messages[M.id]||[],$=e.messages[u.id]||[];if(k.length===0&&$.length===0)return new Date(u.updated_at).getTime()-new Date(M.updated_at).getTime();if(k.length===0)return 1;if($.length===0)return-1;{const P=k[k.length-1],z=$[$.length-1];return new Date(z.timestamp).getTime()-new Date(P.timestamp).getTime()}})),R=y=>{e.setCurrentChatRoom(y),i("select-chat")},D=y=>{l.value=y,h.value="error",s.value=!0},H=()=>{s.value=!1};return G(()=>t.error,y=>{y&&D(y)}),(y,M)=>(o(),n(W,null,[m.value&&c.value.length===0?(o(),n("div",de,M[0]||(M[0]=[r("div",{class:"empty-state-icon"},[r("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[r("path",{d:"M20 2H4C2.9 2 2.01 2.9 2.01 4L2 22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z",fill:"#ccc"})])],-1),r("h3",null,"暂无聊天记录",-1),r("p",null,"您还没有任何聊天消息，开始和好友聊天吧！",-1)]))):b("",!0),r("div",me,[r("div",ve,[(o(!0),n(W,null,se(c.value,u=>(o(),n("div",{key:u.id,class:Y(["chat-item",{active:u.id===B(t).currentChatRoomId}]),onClick:k=>R(u.id)},[T(Z,{user:{id:B(t).getChatRoomDisplayInfo(u).id,username:B(t).getChatRoomDisplayInfo(u).name,user_avatar:B(t).getChatRoomDisplayInfo(u).avatar},size:"medium"},null,8,["user"]),r("div",he,[r("div",pe,[r("span",fe,L(B(t).getChatRoomDisplayInfo(u).name),1),g(u.id)>0?(o(),n("span",we,L(g(u.id)),1)):b("",!0)]),r("div",_e,[r("span",ye,L(_(u.id)),1)])])],10,ge))),128))]),s.value?(o(),O(te,{key:0,message:l.value,type:h.value,onClose:H},null,8,["message","type"])):b("",!0)])],64))}}),Q=E(Ce,[["__scopeId","data-v-4d8281e6"]]),ke="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760855580909'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='2923'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M645.12%200H194.56C112.64%200%2051.2%2066.56%2051.2%20143.36v737.28C51.2%20957.44%20112.64%201024%20194.56%201024h634.88c76.8%200%20143.36-66.56%20143.36-143.36V332.8L645.12%200z%20m20.48%20168.96L803.84%20307.2H665.6V168.96z%20m204.8%20711.68c0%2020.48-15.36%2040.96-40.96%2040.96H194.56c-25.6%200-40.96-20.48-40.96-40.96V143.36c0-20.48%2015.36-40.96%2040.96-40.96H563.2v215.04c0%2051.2%2040.96%2092.16%2092.16%2092.16H870.4v471.04z'%20fill='%2300D6D6'%20p-id='2924'%3e%3c/path%3e%3c/svg%3e",Me={class:"message-content-wrapper"},be={key:1,class:"media-container"},Re=["src","alt"],$e={key:2,class:"media-container"},Te=["src"],Se={key:3,class:"media-container"},Ie=["href","download"],De={key:0,class:"media-filename"},Be=V({__name:"MessageContent",props:{message:{},isSent:{type:Boolean}},emits:["previewMedia"],setup(S,{emit:C}){const m=C,a=e=>{if(!e)return"";const s=new Date(e),l=new Date;return s.toDateString()===l.toDateString()?s.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},i=(e,s=20)=>{if(e.length<=s)return e;const l=e.lastIndexOf(".");if(l===-1)return e.substring(0,s)+"...";const h=e.substring(0,l),g=e.substring(l),_=s-g.length-3;return _<=0?"..."+g.substring(0,s-3):h.substring(0,_)+"..."+g},t=(e,s)=>{m("previewMedia",e,s)};return(e,s)=>(o(),n("div",Me,[e.message.messages_type==="text"?(o(),n("div",{key:0,class:Y(["message-bubble",e.isSent?"sent-bubble":"received-bubble"])},L(e.message.content),3)):e.message.messages_type==="image"?(o(),n("div",be,[r("img",{src:e.message.file,alt:e.message.filename||e.message.content||"",class:"message-image",onClick:s[0]||(s[0]=l=>t(e.message.file,"image"))},null,8,Re)])):e.message.messages_type==="video"?(o(),n("div",$e,[r("video",{src:e.message.file,controls:"",class:"message-video"},null,8,Te)])):e.message.messages_type==="file"?(o(),n("div",Se,[r("a",{href:e.message.file,download:e.message.filename||"",class:"file-download"},s[1]||(s[1]=[r("img",{src:ke,alt:"文件",class:"file-icon-svg"},null,-1)]),8,Ie),e.message.filename?(o(),n("span",De,L(i(e.message.filename)),1)):b("",!0)])):b("",!0),r("div",{class:Y(["message-time",{"time-right":e.isSent}])},L(a(e.message.timestamp)),3)]))}}),X=E(Be,[["__scopeId","data-v-01679206"]]),Le=["id"],Ve={class:"message-avatar"},Ee={key:0,class:"message-username"},Ue={class:"message-content"},ze={class:"message-content"},He={class:"message-avatar"},Pe=V({__name:"MessageItem",props:{message:{},currentUserId:{},currentUser:{}},emits:["previewMedia"],setup(S,{emit:C}){const m=S,a=C,i=I(()=>m.message.sender?.id===m.currentUserId),t=I(()=>m.message.room_type==="group");return(e,s)=>(o(),n("div",{id:`message-${e.message.id}`,class:Y(["message-item",i.value?"sent":"received"])},[i.value?(o(),n(W,{key:1},[r("div",ze,[T(X,{message:e.message,"is-sent":i.value,onPreviewMedia:s[1]||(s[1]=(l,h)=>a("previewMedia",l,h))},null,8,["message","is-sent"])]),r("div",He,[T(Z,{user:e.currentUser,size:"small"},null,8,["user"])])],64)):(o(),n(W,{key:0},[r("div",Ve,[T(Z,{user:e.message.sender,size:"small"},null,8,["user"]),t.value?(o(),n("div",Ee,L(e.message.sender?.username||"未知用户"),1)):b("",!0)]),r("div",Ue,[T(X,{message:e.message,"is-sent":i.value,onPreviewMedia:s[0]||(s[0]=(l,h)=>a("previewMedia",l,h))},null,8,["message","is-sent"])])],64))],10,Le))}}),Ae=E(Pe,[["__scopeId","data-v-1324a99d"]]),Ne={key:0,class:"loading-messages"},Fe={key:1,class:"empty-messages"},Ge={key:2,class:"no-chat-selected-content"},We={key:3,class:"messages-list"},Oe={key:0,class:"loading-more"},Ye={key:1,class:"no-more-messages"},Ze=V({__name:"MessageList",props:{currentChatRoom:{}},emits:["preview-media"],setup(S,{expose:C,emit:m}){const a=S,i=m,t=j(),e=re(),s=f(null),l=f(!1),h=f(null),g=I(()=>e.user?.id||0),_=I(()=>e.user),c=I(()=>a.currentChatRoom?t.messages[a.currentChatRoom.id]||[]:[]),R=I(()=>a.currentChatRoom&&t.isMessagesLoading.get(a.currentChatRoom.id)||!1),D=I(()=>a.currentChatRoom?t.paginationState[a.currentChatRoom.id]:null),H=I(()=>a.currentChatRoom&&D.value&&!D.value.hasMore&&c.value.length>0),y=async v=>{if(v)try{(!t.messages[v]||t.messages[v].length===0)&&await t.getRoomMessages(v),N(()=>{$()})}catch(p){console.error("加载消息失败:",p)}},M=async()=>{if(!a.currentChatRoom||l.value)return;const v=a.currentChatRoom.id,p=D.value;if(!(!p||!p.hasMore||p.isLoadingMore)){h.value=F(),console.log("加载前锚点消息ID:",h.value),l.value=!0;try{const d=await t.getRoomMessages(v,!0);!d.success&&d.error?console.error("加载更多消息失败:",d.error):(await new Promise(w=>setTimeout(w,100)),await N(),await new Promise(w=>setTimeout(w,50)),h.value?await P(h.value):z())}catch(d){console.error("加载更多消息失败:",d)}finally{l.value=!1,h.value=null}}},u=()=>{if(!s.value||!a.currentChatRoom||l.value)return;const{scrollTop:v}=s.value;v<200&&M()},k=(v,p)=>{i("preview-media",v,p)},$=()=>{s.value&&requestAnimationFrame(()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)})},P=async v=>{if(!s.value)return;await N();const p=document.getElementById(`message-${v}`);if(!p){console.warn("锚点元素未找到，使用备用方案"),z();return}const d=s.value,w=p.getBoundingClientRect(),U=d.getBoundingClientRect(),A=w.top-U.top,ae=p.offsetTop-A;d.scrollTop=ae,setTimeout(()=>{if(s.value){const J=document.getElementById(`message-${v}`);if(J){const oe=J.getBoundingClientRect(),ne=s.value.getBoundingClientRect(),ie=oe.top-ne.top;Math.abs(ie-A)>10&&(s.value.scrollTop=J.offsetTop-A)}}},150)},z=()=>{if(!s.value)return;const v=s.value,p=v.querySelectorAll(".message-item");if(p.length>10){const d=p[10];d&&(v.scrollTop=d.offsetTop-50)}},F=()=>{if(!s.value||!c.value.length)return null;const v=s.value,d=v.getBoundingClientRect().top;for(const w of c.value){const U=document.getElementById(`message-${w.id}`);if(U){const A=U.getBoundingClientRect();if(A.top>=d&&A.top<d+v.clientHeight*.3)return w.id}}return c.value[0]?.id||null};return G(()=>c.value.length,(v,p)=>{a.currentChatRoom&&!l.value&&v>p&&N(()=>{$()})}),G(c,(v,p)=>{a.currentChatRoom&&!l.value&&p&&v&&v.length>p.length&&N(()=>{$()})},{deep:!0}),q(()=>{s.value&&s.value.addEventListener("scroll",u),a.currentChatRoom&&y(a.currentChatRoom.id)}),x(()=>{s.value&&s.value.removeEventListener("scroll",u)}),C({scrollToBottom:$,restoreScrollPosition:P,getAnchorMessageId:F,fallbackScrollRestore:z}),(v,p)=>(o(),n("div",{class:"chat-messages",ref_key:"messagesContainer",ref:s,onScroll:u},[R.value?(o(),n("div",Ne," 加载消息中... ")):v.currentChatRoom&&c.value.length===0?(o(),n("div",Fe," 暂无消息，开始聊天吧！ ")):v.currentChatRoom?(o(),n("div",We,[l.value?(o(),n("div",Oe," 加载更多消息中... ")):b("",!0),H.value?(o(),n("div",Ye," 没有更多消息了 ")):b("",!0),(o(!0),n(W,null,se(c.value,d=>(o(),O(Ae,{key:d.id,message:d,"current-user-id":g.value,"current-user":_.value,onPreviewMedia:k},null,8,["message","current-user-id","current-user"]))),128))])):(o(),n("div",Ge,p[0]||(p[0]=[r("p",null,"从左侧列表选择一个聊天开始对话",-1)])))],544))}}),qe=E(Ze,[["__scopeId","data-v-c6b2b491"]]),xe={class:"chat-header"},Ke={key:1,class:"chat-partner-info"},je={class:"partner-details"},Je={class:"partner-name"},Qe={key:2,class:"no-chat-selected"},Xe=V({__name:"ChatHeader",props:{chatRoom:{},isMobile:{type:Boolean}},emits:["back"],setup(S,{emit:C}){const m=K(),a=C,i=()=>{a("back")};return(t,e)=>(o(),n("div",xe,[t.isMobile&&t.chatRoom?(o(),n("button",{key:0,class:"back-button",onClick:i}," ← ")):b("",!0),t.chatRoom?(o(),n("div",Ke,[T(Z,{user:{id:B(m).getChatRoomDisplayInfo(t.chatRoom).id,username:B(m).getChatRoomDisplayInfo(t.chatRoom).name,user_avatar:B(m).getChatRoomDisplayInfo(t.chatRoom).avatar},size:"medium"},null,8,["user"]),r("div",je,[r("span",Je,L(B(m).getChatRoomDisplayInfo(t.chatRoom).name),1)])])):(o(),n("div",Qe," 请选择一个聊天 "))]))}}),es=E(Xe,[["__scopeId","data-v-d00b59d3"]]),ss="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1760852078773'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='980'%20width='16'%20height='16'%20xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cpath%20d='M539.7%20357.6h-55.4v126.7H357.6v55.4h126.7v126.7h55.4V539.7h126.7v-55.4H539.7z'%20p-id='981'%3e%3c/path%3e%3cpath%20d='M512%20142.9c-203.5%200-369.1%20165.6-369.1%20369.1S308.5%20881.1%20512%20881.1%20881.1%20715.5%20881.1%20512%20715.5%20142.9%20512%20142.9z%20m0%20682.7c-172.9%200-313.6-140.7-313.6-313.6S339.1%20198.4%20512%20198.4%20825.6%20339.1%20825.6%20512%20684.9%20825.6%20512%20825.6z'%20p-id='982'%3e%3c/path%3e%3c/svg%3e",ts={class:"message-sender"},as=["disabled"],os=["disabled"],ns=["disabled"],is=V({__name:"MessageSend",props:{disabled:{type:Boolean}},emits:["send-text","send-file"],setup(S,{emit:C}){const m=C,a=f(""),i=f(),t=I(()=>a.value.trim().length>0);function e(){t.value&&(m("send-text",a.value.trim()),a.value="")}function s(g){g.key==="Enter"&&!g.shiftKey&&(g.preventDefault(),e())}function l(){i.value?.click()}function h(g){const _=g.target,c=_.files?.[0];if(!c)return;let R="file";c.type.startsWith("image/")?R="image":c.type.startsWith("video/")&&(R="video"),m("send-file",c,R),_.value=""}return(g,_)=>(o(),n("div",ts,[r("button",{class:"upload-button",disabled:g.disabled,onClick:l},_[1]||(_[1]=[r("img",{src:ss,class:"upload-icon"},null,-1)]),8,as),r("input",{ref_key:"fileInput",ref:i,type:"file",class:"hidden",accept:"image/*,video/*,.pdf,.doc,.docx,.txt,.zip,.rar",onChange:h},null,544),le(r("textarea",{"onUpdate:modelValue":_[0]||(_[0]=c=>a.value=c),class:"message-input",disabled:g.disabled,placeholder:"输入消息…",onKeydown:s,rows:"1"},null,40,os),[[ce,a.value]]),r("button",{class:"send-button",disabled:g.disabled||!t.value,onClick:e},L(g.disabled?"发送中…":"发送"),9,ns)]))}}),rs=E(is,[["__scopeId","data-v-559ffe38"]]),ls=["src","alt"],cs=["src"],us={key:2,class:"loading-indicator"},ds={key:3,class:"error-message"},ms=V({__name:"MediaPreview",props:{show:{type:Boolean,default:!1},previewUrl:{},previewType:{},altText:{default:"媒体预览"}},emits:["close","update:show"],setup(S,{emit:C}){const m=C,a=S,i=f(!0),t=f(!1),e=()=>{m("close"),m("update:show",!1)},s=()=>{e()},l=()=>{i.value=!1,t.value=!1},h=()=>{i.value=!1,t.value=!0},g=()=>{i.value=!1,t.value=!1},_=()=>{i.value=!1,t.value=!0};return G(()=>a.show,c=>{c&&(i.value=!0,t.value=!1)}),G(()=>a.previewUrl,()=>{a.show&&(i.value=!0,t.value=!1)}),(c,R)=>c.show?(o(),n("div",{key:0,class:"media-preview-overlay",onClick:s},[r("div",{class:"media-preview-container",onClick:R[0]||(R[0]=ue(()=>{},["stop"]))},[r("button",{class:"close-preview",onClick:e,"aria-label":"关闭预览"},"×"),c.previewType==="image"?(o(),n("img",{key:0,src:c.previewUrl,class:"preview-image",alt:c.altText,onLoad:l,onError:h},null,40,ls)):c.previewType==="video"?(o(),n("video",{key:1,src:c.previewUrl,class:"preview-video",controls:"",onLoadeddata:g,onError:_}," 您的浏览器不支持视频播放 ",40,cs)):b("",!0),i.value?(o(),n("div",us," 加载中... ")):b("",!0),t.value?(o(),n("div",ds," 加载失败，请重试 ")):b("",!0)])])):b("",!0)}}),vs=E(ms,[["__scopeId","data-v-d2385574"]]),gs={class:"chat-container"},hs=V({__name:"chat",emits:["back"],setup(S,{emit:C}){const m=C,a=K(),i=j(),t=f(!1),e=f(!1),s=f(""),l=f("error"),h=f(!1),g=f(!1),_=f(""),c=f("image"),R=f(),D=()=>{const d=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${d}px`)},H=()=>{h.value=window.innerWidth<=767,h.value&&D()};D(),H(),window.addEventListener("resize",()=>{H(),D()}),window.addEventListener("orientationchange",D);const y=I(()=>a.currentChatRoom),M=()=>{m("back")};q(()=>{i.isUserViewingChat=!0}),x(()=>{i.isUserViewingChat=!1});async function u(d){await $({content:d,messages_type:"text",room_type:"private"})}async function k(d,w){await $({file:d,messages_type:w,room_type:"private"})}async function $(d){if(y.value){t.value=!0;try{const{success:w,error:U}=await i.sendMessage(y.value.id,d);if(!w)throw new Error(U||"未知错误");N(()=>P())}catch(w){z("发送失败: "+w.message)}finally{t.value=!1}}}const P=()=>{R.value?.scrollToBottom()},z=(d,w="error")=>{s.value=d,l.value=w,e.value=!0,setTimeout(()=>{F()},3e3)},F=()=>{e.value=!1},v=(d,w)=>{_.value=d,c.value=w,g.value=!0},p=()=>{g.value=!1};return(d,w)=>(o(),n("div",gs,[T(es,{"chat-room":y.value,"is-mobile":h.value,onBack:M},null,8,["chat-room","is-mobile"]),T(qe,{ref_key:"messageListRef",ref:R,"current-chat-room":y.value,onPreviewMedia:v},null,8,["current-chat-room"]),T(rs,{disabled:t.value,onSendText:u,onSendFile:k},null,8,["disabled"]),T(vs,{show:g.value,"onUpdate:show":w[0]||(w[0]=U=>g.value=U),"preview-url":_.value,"preview-type":c.value,"alt-text":"聊天图片预览",onClose:p},null,8,["show","preview-url","preview-type"]),e.value?(o(),O(te,{key:0,message:s.value,type:l.value,onClose:F},null,8,["message","type"])):b("",!0)]))}}),ee=E(hs,[["__scopeId","data-v-3eb671b8"]]),ps={class:"chat-view"},fs={key:0,class:"mobile-layout"},ws={key:1,class:"desktop-layout"},_s={class:"chat-list-panel"},ys={class:"chat-panel"},Cs=V({__name:"ChatView",setup(S){const C=K(),m=j(),a=f(!1),i=f(!1);let t=0;const e=()=>{i.value=window.innerWidth<768,i.value||(a.value=!0)},s=()=>{t=window.scrollY,a.value=!0,m.isUserViewingChat=!0,i.value&&document.body.classList.add("mobile-chat-open")},l=()=>{a.value=!1,m.isUserViewingChat=!1,C.currentChatRoomId=null,i.value&&(document.body.classList.remove("mobile-chat-open"),window.scrollTo(0,t))},h=()=>{e()};return q(()=>{e(),window.addEventListener("resize",h),i.value&&C.currentChatRoom?(a.value=!0,m.isUserViewingChat=!0):!i.value&&a.value&&(m.isUserViewingChat=!0)}),x(()=>{window.removeEventListener("resize",h),m.isUserViewingChat=!1}),(g,_)=>(o(),n("div",ps,[i.value?(o(),n("div",fs,[a.value?(o(),O(ee,{key:1,onBack:l})):(o(),O(Q,{key:0,onSelectChat:s}))])):(o(),n("div",ws,[r("div",_s,[T(Q,{onSelectChat:s})]),r("div",ys,[T(ee)])]))]))}}),Rs=E(Cs,[["__scopeId","data-v-37829c5c"]]);export{Rs as default};
